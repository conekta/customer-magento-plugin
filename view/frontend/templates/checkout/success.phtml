<?php /** @var $block \Conekta\Payments\Block\Info\Success */ ?>

<div class="checkout-success">

    <?php

    if (in_array($block->getMethod(), ["conekta_ef"])):
        $data = $block->getOfflineInfo();
        if (!empty($data) && isset($data["type"]) && in_array($data["type"], ['oxxo', 'cash', 'spei', 'bankTransfer', 'bnpl', 'pay_by_bank'])):
        ?>

        <h5><?= /* @noEscape */
            __('Instructions:'); ?></h5>
        <p><?= /* @noEscape */
            __($block->getInstructions($data["type"])); ?></p>

        <table class="data" style="margin: 20px; -webkit-margin-start: 0;">
            <tbody>
            <?php
            switch ($data["type"]):
                case "oxxo":
                case "cash":
                    ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Reference Number:'); ?></strong>
                            <span
                                class="conekta_payment_reference"><?= $block->escapeHtml($data["data"]["reference"]); ?></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Expires at:'); ?></strong>
                            <?= $block->escapeHtml(date("Y-m-d", (integer)$data["data"]["expires_at"])); ?>
                        </td>
                    </tr>
                    <?php
                    break;
                case "spei":
                case "bankTransfer":
                    ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('CLABE:'); ?></strong>
                            <span
                                class="conekta_payment_reference"><?= $block->escapeHtml($data["data"]["clabe"]); ?></span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Bank Name:'); ?></strong>
                            <?= $block->escapeHtml($data["data"]["bank_name"]); ?></td>
                    </tr>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Expires at:'); ?></strong>
                            <?= $block->escapeHtml(date("Y-m-d", (integer)$data["data"]["expires_at"])); ?>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Account owner:'); ?></strong>
                            <?= $block->escapeHtml($block->getAccountOwner()); ?>
                        </td>
                    </tr>
                    <?php
                    break;
                case "bnpl":
                    ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Payment Type:'); ?></strong>
                            <?= $block->escapeHtml(__('Buy Now Pay Later')); ?>
                        </td>
                    </tr>
                    <?php if (isset($data["data"]["expires_at"]) && !empty($data["data"]["expires_at"])): ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Expires at:'); ?></strong>
                            <?= $block->escapeHtml(date("Y-m-d", (integer)$data["data"]["expires_at"])); ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php
                    break;
                case "pay_by_bank":
                    ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Payment Type:'); ?></strong>
                            <?= $block->escapeHtml(__('Pay By Bank')); ?>
                        </td>
                    </tr>
                    <?php if (isset($data["data"]["expires_at"]) && !empty($data["data"]["expires_at"])): ?>
                    <tr>
                        <td>
                            <strong><?= /* @noEscape */
                                __('Expires at:'); ?></strong>
                            <?= $block->escapeHtml(date("Y-m-d H:i:s", (integer)$data["data"]["expires_at"])); ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php 
                    // Detectar si es móvil
                    $isMobile = preg_match('/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i', $_SERVER['HTTP_USER_AGENT'] ?? '');
                    $paymentUrl = null;
                    if ($isMobile && isset($data["data"]["deep_link"]) && !empty($data["data"]["deep_link"])): 
                        $paymentUrl = $data["data"]["deep_link"];
                    elseif (!$isMobile && isset($data["data"]["redirect_url"]) && !empty($data["data"]["redirect_url"])): 
                        $paymentUrl = $data["data"]["redirect_url"];
                    endif;
                    ?>
                    <?php if ($paymentUrl): ?>
                    <tr>
                        <td>
                            <a href="<?= $block->escapeUrl($paymentUrl); ?>" target="_blank" class="action primary" rel="noopener noreferrer">
                                <?= /* @noEscape */ __('Complete Payment'); ?>
                            </a>
                            <script type="text/javascript">
                                // Auto-abrir en nueva pestaña
                                (function() {
                                    var paymentUrl = '<?= $block->escapeJs($paymentUrl); ?>';
                                    if (paymentUrl && !sessionStorage.getItem('payByBankOpened')) {
                                        window.open(paymentUrl, '_blank', 'noopener,noreferrer');
                                        sessionStorage.setItem('payByBankOpened', 'true');
                                    }
                                })();
                            </script>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php
                    break;

            endswitch; ?>
            </tbody>
        </table>
        <?php endif; ?>
    <?php endif; ?>
    <p>
        <?= /* @noEscape */
        __('We\'ll email you an order confirmation with details and tracking info.') ?>
    </p>
</div>
